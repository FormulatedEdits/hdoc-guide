#!/usr/bin/env node

const fs = require('fs');
var path = require('path');
const stream = require('stream');
const yaml = require('js-yaml');
const mdfm = require('markdown-it-front-matter');
var hljs = require('highlight.js') // https://highlightjs.org/
const md = require('markdown-it') ({
    // enable everything
    html: true,
    linkify: true,
    typographer: true,
   //  highlight: function (str, lang) {
   //      if (lang && hljs.getLanguage(lang)) {
   //        try {
   //          return hljs.highlight(lang, str, true).value;
   //        } catch (__) {}
   //      }
   //  }
});

var frontmatter_content;
md.use(mdfm, function(fm) {
   frontmatter_content = fm;
});

const tips = require(__dirname + '/custom_modules/tips.js');

md.use(tips, {links: true});

// Default source path to working directory
const source_path = process.cwd();
const ui_path = path.join(__dirname, "ui");

var command = ""; // Our command to run

const commands = {
   "serve": {},
   "build": {}
};

// Get options from command args
for(x = 0; x < process.argv.length; x++)
{
   // First two arguments are command, and script
   if(x == 0 || x == 1)
      continue;
   // Third argument is command
   if(x == 2) {
      command = process.argv[x];
      // Is command allowed
      if(commands[command] === undefined)
         throw "The specified command '" + command + "' is not known\r\n";
   }

   if(process.argv[x] == "-path") {
      x++;
      if(x < process.argv.length)
      {
         source_path = process.argv[x];
      }    
   } else if(process.argv[x] == "-ui-path") {
      x++;
      if(x < process.argv.length)
      {
          ui_path = process.argv[x];
      }    
   }
}

console.log("Hornbill HDocBook Tools v0.1", "\r\n");
console.log("    Server Path:", __dirname);
console.log("  Document Path:", source_path, "\r\n");

if(command == "serve") {
   const server = require(path.join(__dirname, "hdoc-serve.js"));

   server.run(ui_path, source_path, md);
} else if(command == "build") {

   const builder = require(path.join(__dirname, "hdoc-build.js"));

   builder.run(ui_path, source_path, md);
}

